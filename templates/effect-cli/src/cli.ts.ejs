import { Args, Command, Options } from '@effect/cli';
import { BunContext, BunRuntime } from '@effect/platform-bun';
import { Console, Effect, Layer, pipe } from 'effect';
import { name, version } from '../package.json';
import { HelloService } from './services/hello.js';
import { ConfigService, ConfigServiceLive } from './services/config.js';

// Define CLI arguments and options
const nameArg = Args.text({ name: 'name' }).pipe(Args.optional);

const greetingOption = Options.text('greeting').pipe(
  Options.withAlias('g'),
  Options.withDefault('Hello'),
  Options.withDescription('Custom greeting message')
);

const loudOption = Options.boolean('loud').pipe(
  Options.withAlias('l'),
  Options.withDefault(false),
  Options.withDescription('Use loud greeting (uppercase)')
);

// Hello command
const helloCommand = Command.make(
  'hello',
  { name: nameArg, greeting: greetingOption, loud: loudOption },
  ({ name, greeting, loud }) =>
    Effect.gen(function* () {
      const hello = yield* HelloService;
      const targetName = name ?? 'World';
      const message = yield* hello.greet(targetName, { greeting, loud });
      yield* Console.log(message);
    })
).pipe(
  Command.withDescription('Greet someone')
);

// Config command
const configCommand = Command.make('config', {}, () =>
  Effect.gen(function* () {
    const config = yield* ConfigService;
    const settings = yield* config.load();
    yield* Console.log('Current configuration:');
    yield* Console.log(JSON.stringify(settings, null, 2));
  })
).pipe(
  Command.withDescription('Show current configuration')
);

// Root command
const rootCommand = Command.make(name, {}, () =>
  Effect.gen(function* () {
    yield* Console.log(`${name} v${version}`);
    yield* Console.log('');
    yield* Console.log('A CLI tool built with Effect-ts');
    yield* Console.log('');
    yield* Console.log('Commands:');
    yield* Console.log('  hello   Greet someone');
    yield* Console.log('  config  Show configuration');
    yield* Console.log('');
    yield* Console.log('Use --help for more information');
  })
).pipe(
  Command.withSubcommands([helloCommand, configCommand]),
  Command.withDescription('<%= description %>')
);

// Create the CLI
const cli = Command.run(rootCommand, {
  name,
  version,
});

// Main layer composition
const MainLayer = Layer.mergeAll(
  HelloService.Default,
  ConfigServiceLive
);

// Run the CLI
pipe(
  Effect.suspend(() => cli(process.argv)),
  Effect.provide(MainLayer),
  Effect.provide(BunContext.layer),
  BunRuntime.runMain
);
