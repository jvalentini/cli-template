import { describe, expect, it } from 'bun:test';
import { Effect, Exit, Layer } from 'effect';
import { HelloService } from '../src/services/hello.js';
import { ConfigService, ConfigServiceLive } from '../src/services/config.js';

describe('HelloService', () => {
  it('should greet with default message', async () => {
    const program = Effect.gen(function* () {
      const hello = yield* HelloService;
      return yield* hello.greet('World');
    });

    const result = await Effect.runPromise(
      program.pipe(Effect.provide(HelloService.Default))
    );

    expect(result).toBe('Hello, World!');
  });

  it('should greet with custom greeting', async () => {
    const program = Effect.gen(function* () {
      const hello = yield* HelloService;
      return yield* hello.greet('Alice', { greeting: 'Hi' });
    });

    const result = await Effect.runPromise(
      program.pipe(Effect.provide(HelloService.Default))
    );

    expect(result).toBe('Hi, Alice!');
  });

  it('should greet loudly when loud option is true', async () => {
    const program = Effect.gen(function* () {
      const hello = yield* HelloService;
      return yield* hello.greet('Bob', { loud: true });
    });

    const result = await Effect.runPromise(
      program.pipe(Effect.provide(HelloService.Default))
    );

    expect(result).toBe('HELLO, BOB!');
  });
});

describe('ConfigService', () => {
  it('should load default config', async () => {
    const program = Effect.gen(function* () {
      const config = yield* ConfigService;
      return yield* config.load();
    });

    const result = await Effect.runPromise(
      program.pipe(Effect.provide(ConfigServiceLive))
    );

    expect(result).toHaveProperty('version');
    expect(result).toHaveProperty('debug');
    expect(result).toHaveProperty('logLevel');
  });

  it('should return config path', async () => {
    const program = Effect.gen(function* () {
      const config = yield* ConfigService;
      return yield* config.getConfigPath();
    });

    const result = await Effect.runPromise(
      program.pipe(Effect.provide(ConfigServiceLive))
    );

    expect(result).toContain('<%= projectName %>');
    expect(result).toContain('config.json');
  });
});
